<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProMEL Analytics Solutions | PMCEL Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #003366;
      --primary-light: #e9f1ff;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --status-good: #0a7a29;
      --status-warn: #b8860b;
      --status-bad: #b22222;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #333;
    }

    header {
      background: var(--primary);
      color: #fff;
      padding: 16px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .container {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Card grid */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      text-align: center;
      cursor: pointer;
      transition: transform 0.15s, background 0.15s;
      font-size: 0.9rem;
    }

    .card h3 {
      margin: 0 0 6px;
      color: var(--primary);
      font-size: 1rem;
    }

    .card p {
      margin: 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .card:hover {
      transform: translateY(-2px);
      background: var(--primary-light);
    }

    /* Sections */
    .section {
      display: none;
      background: var(--card-bg);
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      font-size: 0.9rem;
    }

    .section h2 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .section p {
      margin: 4px 0 10px;
      font-size: 0.85rem;
    }

    .close-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 10px;
    }

    .close-btn:hover {
      opacity: 0.9;
    }

    /* Responsive table wrapper */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 480px; /* allows horizontal scroll on very small screens */
    }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #eef3fb;
      color: var(--primary);
      font-weight: bold;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .info-note {
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
    }

    /* Status colours for numeric ratings */
    .status-good {
      color: var(--status-good);
      font-weight: bold;
    }
    .status-warn {
      color: var(--status-warn);
      font-weight: bold;
    }
    .status-bad {
      color: var(--status-bad);
      font-weight: bold;
    }

    .legend {
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .legend span {
      margin-right: 12px;
    }

    footer {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 10px;
      font-size: 0.8rem;
      margin-top: 30px;
    }

    /* KPI layout for Overview / Reports / Learning */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin: 10px 0 16px;
    }

    .kpi-box {
      background: var(--primary-light);
      border-radius: 8px;
      padding: 10px;
      text-align: left;
    }

    .kpi-label {
      font-size: 0.75rem;
      color: #555;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
    }

    /* Learning list */
    #learning-list {
      list-style: none;
      padding-left: 0;
      margin: 8px 0 0;
      font-size: 0.8rem;
    }

    #learning-list li {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>

<body>

<header>
  <h1>ProMEL Analytics Solutions</h1>
  <p>Project Monitoring &amp; Control, Evaluation &amp; Learning (PMCEL) Dashboard</p>
</header>

<div class="container">

  <!-- Navigation cards -->
  <div class="cards">
    <div class="card" onclick="openSection('overview')">
      <h3>Overview</h3>
      <p>High-level project performance summary.</p>
    </div>

    <div class="card" onclick="openSection('monitoring')">
      <h3>Monitoring &amp; Control</h3>
      <p>Live data from ProMEL monitoring CSV file.</p>
    </div>

    <div class="card" onclick="openSection('evaluation')">
      <h3>Evaluation</h3>
      <p>Findings and ratings from evaluation CSV file.</p>
    </div>

    <div class="card" onclick="openSection('learning')">
      <h3>Learning</h3>
      <p>Lessons learned &amp; adaptive management.</p>
    </div>

    <div class="card" onclick="openSection('reports')">
      <h3>Reports</h3>
      <p>Monitoring and evaluation reporting hub.</p>
    </div>

    <div class="card" onclick="openSection('powerbi')">
      <h3>Power BI Dashboard</h3>
      <p>Integrated business intelligence view.</p>
    </div>
  </div>

  <!-- Sections -->

  <!-- OVERVIEW: now live, using monitoring & evaluation CSV data -->
  <div id="overview" class="section">
    <h2>Project Overview</h2>
    <p>
      Live summary of key PMCEL indicators based on Monitoring &amp; Evaluation data.
    </p>

    <div class="kpi-grid">
      <div class="kpi-box">
        <div class="kpi-label">Total Projects</div>
        <div class="kpi-value" id="ov-total-projects">0</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Total Monitoring Records</div>
        <div class="kpi-value" id="ov-total-monitoring">0</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Total Evaluation Records</div>
        <div class="kpi-value" id="ov-total-evaluation">0</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Total Beneficiaries Reached</div>
        <div class="kpi-value" id="ov-total-beneficiaries">0</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Overall Performance Score (Activity &amp; Budget)</div>
        <div class="kpi-value" id="ov-overall-score">0</div>
      </div>
    </div>

    <button class="close-btn" onclick="closeSection('overview')">Close</button>
  </div>

  <div id="monitoring" class="section">
    <h2>Monitoring &amp; Control ‚Äì CSV Feed</h2>
    <p>
      The table below is populated from the <code>monitoring_data.csv</code> file stored in this repository.
      It is designed to be mobile friendly and scrollable on small screens.
    </p>

    <div class="table-wrapper">
      <table>
        <thead id="monitoring-head">
          <!-- CSV header row will be inserted here -->
        </thead>
        <tbody id="monitoring-body">
          <!-- CSV data rows will be inserted here -->
        </tbody>
      </table>
    </div>

    <div class="legend">
      <strong>Monitoring rating colour key (1‚Äì5):</strong>
      <span class="status-bad">1‚Äì2 = Off-track / Poor</span>
      <span class="status-warn">3 = Moderate / Watch</span>
      <span class="status-good">4‚Äì5 = On-track / Good</span>
    </div>

    <div class="info-note">
      On mobile, swipe left/right to view all columns.
    </div>

    <button class="close-btn" onclick="closeSection('monitoring')">Close</button>
  </div>

  <div id="evaluation" class="section">
    <h2>Evaluation ‚Äì CSV Feed</h2>
    <p>
      The table below is populated from the <code>evaluation_data.csv</code> file stored in this repository.
      It provides an overview of evaluation phase, overall rating, key findings and recommendations.
    </p>

    <div class="table-wrapper">
      <table>
        <thead id="evaluation-head">
          <!-- Evaluation CSV header row will be inserted here -->
        </thead>
        <tbody id="evaluation-body">
          <!-- Evaluation CSV data rows will be inserted here -->
        </tbody>
      </table>
    </div>

    <div class="legend">
      <strong>Evaluation rating colour key (1‚Äì5):</strong>
      <span class="status-bad">1‚Äì2 = Weak / Unsatisfactory</span>
      <span class="status-warn">3 = Fair / Needs improvement</span>
      <span class="status-good">4‚Äì5 = Good / Strong</span>
    </div>

    <div class="info-note">
      On mobile, swipe left/right to view all columns.
    </div>

    <button class="close-btn" onclick="closeSection('evaluation')">Close</button>
  </div>

  <!-- LEARNING: now live, using recent monitoring records -->
  <div id="learning" class="section">
    <h2>Learning &amp; Knowledge</h2>
    <p>
      Recent achievements, challenges and management recommendations from Monitoring data.
    </p>

    <ul id="learning-list">
      <!-- Live learning items inserted from monitoring_data.csv -->
    </ul>

    <button class="close-btn" onclick="closeSection('learning')">Close</button>
  </div>

  <!-- REPORTS: now live, based on monitoring metadata -->
  <div id="reports" class="section">
    <h2>Reports</h2>
    <p>
      Live reporting status from Monitoring records. This can be expanded later with links
      to automated narrative or dashboard reports.
    </p>

    <div class="kpi-grid">
      <div class="kpi-box">
        <div class="kpi-label">Total Reports Submitted</div>
        <div class="kpi-value" id="rep-total">0</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Latest Reporting Period</div>
        <div class="kpi-value" id="rep-period">N/A</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">Latest Reporting Date</div>
        <div class="kpi-value" id="rep-date">N/A</div>
      </div>
    </div>

    <button class="close-btn" onclick="closeSection('reports')">Close</button>
  </div>

  <div id="powerbi" class="section">
    <h2>Power BI Dashboard</h2>
    <p>
      When your Power BI report is ready and published, you can embed it here using an
      &lt;iframe&gt; from Power BI.
    </p>

    <!-- Example placeholder only -->
    <div class="table-wrapper" style="text-align:center; padding:16px; border-style:dashed;">
      Power BI embed placeholder.<br>
      Replace this box with the Power BI &lt;iframe&gt; when available.
    </div>

    <button class="close-btn" onclick="closeSection('powerbi')">Close</button>
  </div>

</div>

<footer>
  &copy; 2025 ProMEL Analytics Solutions | Digital PMCEL System
</footer>

<script>
  // Global data arrays (include header row)
  let monitoringRows = [];
  let evaluationRows = [];

  // Show/Hide sections
  function openSection(id) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function closeSection(id) {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'none';
    }
  }

  // ===== CSV LOADERS =====
  document.addEventListener('DOMContentLoaded', function () {
    loadMonitoringTable();
    loadEvaluationTable();
  });

  function loadMonitoringTable() {
    const csvUrl = "monitoring_data.csv";

    fetch(csvUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error("HTTP " + response.status + " when fetching " + csvUrl);
        }
        return response.text();
      })
      .then(text => {
        const rows = parseCSV(text);
        if (!rows || rows.length === 0) {
          throw new Error("Monitoring CSV file is empty or could not be parsed.");
        }

        monitoringRows = rows; // store globally for KPIs

        const thead = document.getElementById('monitoring-head');
        const tbody = document.getElementById('monitoring-body');

        thead.innerHTML = "";
        tbody.innerHTML = "";

        // First row = header
        const headerRow = document.createElement('tr');
        rows[0].forEach(cell => {
          const th = document.createElement('th');
          th.textContent = cell;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Identify rating columns by header name
        const headerNames = rows[0].map(h => h.trim().toLowerCase());
        const ratingHeaders = [
          "activity implementation on schedule",
          "budget utilization as planned",
          "staff availability",
          "community participation",
          "coordination with partners"
        ];
        const ratingIndices = [];

        headerNames.forEach((name, idx) => {
          ratingHeaders.forEach(target => {
            if (name === target) {
              ratingIndices.push(idx);
            }
          });
        });

        // Data rows
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.every(c => c.trim() === "")) continue; // skip empty rows

          const tr = document.createElement('tr');

          row.forEach((cell, idx) => {
            const td = document.createElement('td');
            const text = cell.trim();
            td.textContent = text;

            // Apply colours if this column is one of the rating indices
            if (ratingIndices.includes(idx) && text !== "") {
              const value = parseFloat(text);
              if (!isNaN(value)) {
                if (value >= 4) {
                  td.classList.add("status-good");   // 4‚Äì5
                } else if (value <= 2) {
                  td.classList.add("status-bad");    // 1‚Äì2
                } else if (value === 3) {
                  td.classList.add("status-warn");   // 3
                }
              }
            }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }

        // Update KPI cards that rely on Monitoring data
        updateOverviewCard();
        updateLearningCard();
        updateReportsCard();
      })
      .catch(err => {
        console.error("Error loading Monitoring CSV:", err);
        const tbody = document.getElementById('monitoring-body');
        if (tbody) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.textContent = "Error loading monitoring data: " + err.message;
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      });
  }

  function loadEvaluationTable() {
    const csvUrl = "evaluation_data.csv";

    fetch(csvUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error("HTTP " + response.status + " when fetching " + csvUrl);
        }
        return response.text();
      })
      .then(text => {
        const rows = parseCSV(text);
        if (!rows || rows.length === 0) {
          throw new Error("Evaluation CSV file is empty or could not be parsed.");
        }

        evaluationRows = rows; // store globally for KPIs

        const thead = document.getElementById('evaluation-head');
        const tbody = document.getElementById('evaluation-body');

        thead.innerHTML = "";
        tbody.innerHTML = "";

        // First row = header
        const headerRow = document.createElement('tr');
        rows[0].forEach(cell => {
          const th = document.createElement('th');
          th.textContent = cell;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Find rating column (header contains 'rating')
        const headerNames = rows[0].map(h => h.trim().toLowerCase());
        let ratingIndex = -1;
        headerNames.forEach((name, idx) => {
          if (name.includes("rating") && ratingIndex === -1) {
            ratingIndex = idx;
          }
        });

        // Data rows
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.every(c => c.trim() === "")) continue; // skip empty rows

          const tr = document.createElement('tr');

          row.forEach((cell, idx) => {
            const td = document.createElement('td');
            const text = cell.trim();
            td.textContent = text;

            // Apply colours if this is the rating column
            if (ratingIndex === idx && text !== "") {
              const value = parseFloat(text);
              if (!isNaN(value)) {
                if (value >= 4) {
                  td.classList.add("status-good");   // 4‚Äì5
                } else if (value <= 2) {
                  td.classList.add("status-bad");    // 1‚Äì2
                } else if (value === 3) {
                  td.classList.add("status-warn");   // 3
                }
              }
            }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }

        // Update KPI cards that also use Evaluation data
        updateOverviewCard();
      })
      .catch(err => {
        console.error("Error loading Evaluation CSV:", err);
        const tbody = document.getElementById('evaluation-body');
        if (tbody) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.textContent = "Error loading evaluation data: " + err.message;
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      });
  }

  // Very simple CSV parser (works if no commas inside cells)
  function parseCSV(text) {
    const lines = text.trim().split("\n");
    return lines.map(line => line.split(","));
  }

  // ===== KPI / CARD HELPERS =====

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function averageFieldFromRows(rows, headerRow, headerNameLower) {
    if (!rows.length || !headerRow.length) return 0;
    const headers = headerRow.map(h => h.trim().toLowerCase());
    const idx = headers.indexOf(headerNameLower);
    if (idx === -1) return 0;

    let sum = 0;
    let count = 0;

    for (let i = 1; i < rows.length; i++) {
      const cell = rows[i][idx];
      const v = parseFloat(cell);
      if (!isNaN(v)) {
        sum += v;
        count++;
      }
    }

    return count ? sum / count : 0;
  }

  // ===== OVERVIEW CARD =====
  function updateOverviewCard() {
    if (!monitoringRows.length) return;

    const headerRow = monitoringRows[0];
    const headersLower = headerRow.map(h => h.trim().toLowerCase());

    const idxProject = headersLower.indexOf('project name');
    const idxBenef   = headersLower.indexOf('number of beneficiaries reached this period.');
    const idxAct     = headersLower.indexOf('activity implementation on schedule');
    const idxBud     = headersLower.indexOf('budget utilization as planned');

    const projectSet = new Set();
    let totalBeneficiaries = 0;
    let monCount = 0;

    for (let i = 1; i < monitoringRows.length; i++) {
      const row = monitoringRows[i];
      if (row.every(c => c.trim() === "")) continue;

      monCount++;

      if (idxProject !== -1 && row[idxProject]) {
        projectSet.add(row[idxProject].trim());
      }

      if (idxBenef !== -1 && row[idxBenef] !== undefined) {
        const b = parseFloat(row[idxBenef]);
        if (!isNaN(b)) totalBeneficiaries += b;
      }
    }

    const totalMonitoring = monCount;
    const totalEvaluation = evaluationRows.length > 1 ? (evaluationRows.length - 1) : 0;

    const avgActivity = idxAct !== -1
      ? averageFieldFromRows(monitoringRows, headerRow, 'activity implementation on schedule')
      : 0;

    const avgBudget = idxBud !== -1
      ? averageFieldFromRows(monitoringRows, headerRow, 'budget utilization as planned')
      : 0;

    const overallScore = (avgActivity || avgBudget)
      ? ((avgActivity + avgBudget) / 2).toFixed(1)
      : "0";

    setText('ov-total-projects', projectSet.size);
    setText('ov-total-monitoring', totalMonitoring);
    setText('ov-total-evaluation', totalEvaluation);
    setText('ov-total-beneficiaries', totalBeneficiaries);
    setText('ov-overall-score', overallScore);
  }

  // ===== LEARNING CARD =====
  function updateLearningCard() {
    if (!monitoringRows.length) return;

    const headerRow = monitoringRows[0];
    const headersLower = headerRow.map(h => h.trim().toLowerCase());

    const idxProject      = headersLower.indexOf('project name');
    const idxPeriod       = headersLower.indexOf('reporting period');
    const idxAchieve      = headersLower.indexOf('main achievements his period.');
    const idxChallenges   = headersLower.indexOf('key challenges / risks');
    const idxActions      = headersLower.indexOf('immediate actions required / recommendations');

    const list = document.getElementById('learning-list');
    if (!list) return;
    list.innerHTML = "";

    // Take last 6 non-empty records (most recent)
    const dataRows = monitoringRows.slice(1).filter(r => !r.every(c => c.trim() === ""));
    const recent = dataRows.slice(-6).reverse();

    recent.forEach(row => {
      const li = document.createElement('li');

      const project = idxProject !== -1 ? (row[idxProject] || '') : '';
      const period  = idxPeriod  !== -1 ? (row[idxPeriod]  || '') : '';

      const ach  = idxAchieve    !== -1 ? (row[idxAchieve]    || '') : '';
      const chal = idxChallenges !== -1 ? (row[idxChallenges] || '') : '';
      const act  = idxActions    !== -1 ? (row[idxActions]    || '') : '';

      li.innerHTML = `
        <strong>${project}</strong> ‚Äì ${period}<br>
        ‚úÖ ${ach}<br>
        ‚ö†Ô∏è ${chal}<br>
        üìå ${act}
      `;

      list.appendChild(li);
    });
  }

  // ===== REPORTS CARD =====
  function updateReportsCard() {
    if (!monitoringRows.length) return;

    const headerRow = monitoringRows[0];
    const headersLower = headerRow.map(h => h.trim().toLowerCase());

    const idxPeriod = headersLower.indexOf('reporting period');
    const idxDate   = headersLower.indexOf('reporting date');

    const dataRows = monitoringRows.slice(1).filter(r => !r.every(c => c.trim() === ""));
    const totalReports = dataRows.length;

    let latestPeriod = 'N/A';
    let latestDate   = 'N/A';

    if (dataRows.length > 0) {
      const lastRow = dataRows[dataRows.length - 1];
      if (idxPeriod !== -1) latestPeriod = lastRow[idxPeriod] || 'N/A';
      if (idxDate   !== -1) latestDate   = lastRow[idxDate]   || 'N/A';
    }

    setText('rep-total', totalReports);
    setText('rep-period', latestPeriod);
    setText('rep-date', latestDate);
  }
</script>

</body>
</html>
