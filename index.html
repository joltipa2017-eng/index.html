<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProMEL Analytics Solutions | PMCEL Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #003366;
      --primary-light: #e9f1ff;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --status-good: #0a7a29;
      --status-warn: #b8860b;
      --status-bad: #b22222;
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #333;
    }

    /* LOGIN */
    #login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #003366, #005599);
      color: #fff;
    }

    .login-card {
      background: rgba(255,255,255,0.08);
      padding: 22px;
      border-radius: 12px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 6px 16px rgba(0,0,0,.3);
    }

    .login-card h2 { margin: 0 0 6px; }
    .login-card label { display:block; font-size:.8rem; margin-top:8px; }
    .login-card input {
      width:100%; padding:6px; border-radius:6px; border:none;
    }

    .login-btn {
      margin-top:14px;
      width:100%;
      padding:8px;
      border:none;
      border-radius:8px;
      background:#ffcc00;
      font-weight:bold;
      cursor:pointer;
    }

    #app-root { display:none; }

    header {
      background: var(--primary);
      color:#fff;
      padding:16px;
      text-align:center;
    }

    .container {
      padding:16px;
      max-width:1100px;
      margin:auto;
    }

    .filters-bar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      background:#e9f1ff;
      padding:8px;
      border-radius:8px;
      font-size:.8rem;
      margin-bottom:12px;
    }

    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
      margin-bottom:18px;
    }

    .card {
      background:#fff;
      padding:14px;
      border-radius:10px;
      box-shadow:0 3px 6px rgba(0,0,0,.08);
      text-align:center;
      cursor:pointer;
    }

    .section {
      display:none;
      background:#fff;
      padding:16px;
      border-radius:10px;
      box-shadow:0 3px 6px rgba(0,0,0,.08);
      margin-bottom:24px;
    }

    .table-wrapper {
      overflow-x:auto;
      border:1px solid #e0e0e0;
      border-radius:8px;
      padding:4px;
      margin-top:8px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      min-width:480px;
    }

    th, td {
      padding:6px;
      border-bottom:1px solid #eee;
      white-space:nowrap;
    }

    th {
      background:#eef3fb;
      color:var(--primary);
    }

    .status-good { color:var(--status-good); font-weight:bold; }
    .status-warn { color:var(--status-warn); font-weight:bold; }
    .status-bad  { color:var(--status-bad);  font-weight:bold; }

    .kpi-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin:12px 0;
    }

    .kpi-box {
      background:var(--primary-light);
      border-radius:8px;
      padding:10px;
    }

    .kpi-label { font-size:.75rem; }
    .kpi-value { font-size:1.1rem; font-weight:bold; }

    canvas { max-width:100%; }

    footer {
      background:var(--primary);
      color:#fff;
      padding:10px;
      text-align:center;
      font-size:.8rem;
    }
  </style>
</head>
<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <h2>ProMEL Dashboard Login</h2>
    <p style="margin:0 0 12px; font-size:.85rem; opacity:.9;">
      Secure access to the PMCEL Monitoring, Evaluation &amp; Learning dashboard.
    </p>

    <form id="login-form">
      <label for="login-username">Username</label>
      <input id="login-username" type="text" required>

      <label for="login-password">Password</label>
      <input id="login-password" type="password" required>

      <button type="submit" class="login-btn">Login</button>
    </form>

    <div style="margin-top:10px; font-size:.75rem; opacity:.9;">
      Default (change later in code):<br>
      <strong>Username:</strong> <code>admin</code><br>
      <strong>Password:</strong> <code>ProMEL@2025</code>
    </div>
  </div>
</div>

<!-- APP ROOT -->
<div id="app-root">
  <header>
    <h1 style="margin:0; font-size:1.4rem;">ProMEL Analytics Solutions</h1>
    <p style="margin:4px 0 0; font-size:.9rem; opacity:.9;">
      Project Monitoring &amp; Control, Evaluation &amp; Learning (PMCEL) Dashboard
    </p>
  </header>

  <div class="container">

    <!-- Filters -->
    <div id="filters-bar" class="filters-bar">
      <strong>Filters:</strong>

      <label>
        Project:
        <select id="filter-project">
          <option value="">All</option>
        </select>
      </label>

      <label>
        Period:
        <select id="filter-period">
          <option value="">All</option>
        </select>
      </label>

      <label>
        Location:
        <select id="filter-location">
          <option value="">All</option>
        </select>
      </label>
    </div>

    <!-- Navigation cards -->
    <div class="cards">
      <div class="card" onclick="openSection('overview')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Overview</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">High-level project performance summary.</p>
      </div>

      <div class="card" onclick="openSection('monitoring')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Monitoring &amp; Control</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Live data from Monitoring Google Sheet (CSV feed).</p>
      </div>

      <div class="card" onclick="openSection('evaluation')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Evaluation</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Findings and ratings from Evaluation Google Sheet (CSV feed).</p>
      </div>

      <div class="card" onclick="openSection('learning')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Learning</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Lessons learned &amp; adaptive management.</p>
      </div>

      <div class="card" onclick="openSection('reports')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Reports</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Monitoring and evaluation reporting hub.</p>
      </div>

      <div class="card" onclick="openSection('dataentry')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Data Entry</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Quick Monitoring &amp; Evaluation input forms.</p>
      </div>

      <div class="card" onclick="openSection('powerbi')">
        <h3 style="margin:0 0 6px; color:var(--primary);">Power BI Dashboard</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Integrated business intelligence view.</p>
      </div>

      <div class="card" onclick="openSection('openai')">
        <h3 style="margin:0 0 6px; color:var(--primary);">AI Assistant (OpenAI)</h3>
        <p style="margin:0; font-size:.8rem; opacity:.9;">Analyse trends &amp; generate MEL reports.</p>
      </div>
    </div>

    <!-- OVERVIEW -->
    <div id="overview" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Project Overview</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        Live summary of key PMCEL indicators based on Monitoring &amp; Evaluation data.
        Filters at the top (Project, Period, Location) adjust the figures below.
      </p>

      <div class="kpi-grid">
        <div class="kpi-box">
          <div class="kpi-label">Total Projects</div>
          <div class="kpi-value" id="ov-total-projects">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Total Monitoring Records</div>
          <div class="kpi-value" id="ov-total-monitoring">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Total Evaluation Records</div>
          <div class="kpi-value" id="ov-total-evaluation">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Total Beneficiaries Reached</div>
          <div class="kpi-value" id="ov-total-beneficiaries">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Overall Performance Score (Activity &amp; Budget)</div>
          <div class="kpi-value" id="ov-overall-score">0</div>
        </div>
      </div>

      <div class="table-wrapper" style="margin-top:12px;">
        <canvas id="chart-avg-ratings"></canvas>
      </div>

      <div class="table-wrapper" style="margin-top:12px;">
        <canvas id="chart-beneficiaries"></canvas>
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('overview')">Close</button>
    </div>

    <!-- MONITORING -->
    <div id="monitoring" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Monitoring &amp; Control ‚Äì Live CSV Feed</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        The table below is populated from the Monitoring Google Sheet published as a CSV link.
        Filters at the top will reduce this table to the selected project/period/location.
      </p>

      <div class="table-wrapper">
        <table>
          <thead id="monitoring-head"></thead>
          <tbody id="monitoring-body"></tbody>
        </table>
      </div>

      <!-- ‚úÖ Monitoring summary graphs (by Period / Month) -->
      <div class="table-wrapper" style="margin-top:12px;">
        <div style="margin:6px 4px 10px; font-size:.8rem; color:#666;">
          <strong>Monitoring Summary Graphs</strong> (auto from filtered table)
          &nbsp;|&nbsp; Group by:
          <select id="mon-groupby" style="padding:4px 6px; border-radius:6px; border:1px solid #ccc;">
            <option value="period" selected>Reporting Period</option>
            <option value="month">Month (from Reporting Date)</option>
          </select>
        </div>
        <canvas id="mon-chart-overall-by-group"></canvas>
      </div>

      <div class="table-wrapper" style="margin-top:12px;">
        <canvas id="mon-chart-beneficiaries-by-group"></canvas>
      </div>

      <div style="margin-top:10px; font-size:.78rem;">
        <strong>Monitoring rating colour key (1‚Äì5):</strong>
        <span class="status-bad">1‚Äì2 = Off-track / Poor</span>&nbsp;&nbsp;
        <span class="status-warn">3 = Moderate / Watch</span>&nbsp;&nbsp;
        <span class="status-good">4‚Äì5 = On-track / Good</span>
      </div>

      <div style="margin-top:6px; font-size:.75rem; color:#666;">
        On mobile, swipe left/right to view all columns.
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('monitoring')">Close</button>
    </div>

    <!-- EVALUATION -->
    <div id="evaluation" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Evaluation ‚Äì Live CSV Feed</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        The table below is populated from the Evaluation Google Sheet published as a CSV link.
        Filters at the top adjust this table as well.
      </p>

      <!-- ‚úÖ NEW: Evaluation Overall Ratings (Auto % + Statistics) -->
      <div class="kpi-grid" style="margin-top:4px;">
        <div class="kpi-box">
          <div class="kpi-label">Overall Outcome Rating</div>
          <div class="kpi-value" id="ev-outcome-score">0.0 / 5</div>
          <div style="font-size:.78rem; opacity:.9;" id="ev-outcome-percent">0%</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Overall Impact Rating</div>
          <div class="kpi-value" id="ev-impact-score">0.0 / 5</div>
          <div style="font-size:.78rem; opacity:.9;" id="ev-impact-percent">0%</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Overall Project Performance Rating</div>
          <div class="kpi-value" id="ev-performance-score">0.0 / 5</div>
          <div style="font-size:.78rem; opacity:.9;" id="ev-performance-percent">0%</div>
        </div>
      </div>

      <!-- Optional visual: Outcome vs Impact averages -->
      <div class="table-wrapper" style="margin-top:12px;">
        <canvas id="ev-chart-outcome-impact"></canvas>
      </div>

      <div class="table-wrapper">
        <table>
          <thead id="evaluation-head"></thead>
          <tbody id="evaluation-body"></tbody>
        </table>
      </div>

      <div style="margin-top:10px; font-size:.78rem;">
        <strong>Evaluation rating colour key (1‚Äì5):</strong>
        <span class="status-bad">1‚Äì2 = Weak / Unsatisfactory</span>&nbsp;&nbsp;
        <span class="status-warn">3 = Fair / Needs improvement</span>&nbsp;&nbsp;
        <span class="status-good">4‚Äì5 = Good / Strong</span>
      </div>

      <div style="margin-top:6px; font-size:.75rem; color:#666;">
        On mobile, swipe left/right to view all columns.
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('evaluation')">Close</button>
    </div>

    <!-- LEARNING -->
    <div id="learning" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Learning &amp; Knowledge</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        Recent achievements, challenges and management recommendations from Monitoring data,
        filtered by the selections at the top.
      </p>

      <ul id="learning-list" style="list-style:none; padding-left:0; margin:8px 0 0; font-size:.85rem;"></ul>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('learning')">Close</button>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Reports</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        Live reporting status from Monitoring records. You can also export a quick PDF summary
        of the Overview KPIs for management or donors.
      </p>

      <div class="kpi-grid">
        <div class="kpi-box">
          <div class="kpi-label">Total Reports Submitted</div>
          <div class="kpi-value" id="rep-total">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Latest Reporting Period</div>
          <div class="kpi-value" id="rep-period">N/A</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Latest Reporting Date</div>
          <div class="kpi-value" id="rep-date">N/A</div>
        </div>
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="generatePDFReport()">Download PDF Summary</button>
      <button class="login-btn" style="background:var(--primary); color:#fff; margin-top:8px;" onclick="closeSection('reports')">Close</button>
    </div>

    <!-- DATA ENTRY -->
    <div id="dataentry" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Data Entry (Monitoring &amp; Evaluation)</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        These forms are a front-end template. To send data directly into Google Sheets, connect
        them to a Google Apps Script Web App or Google Form endpoint in the JavaScript code.
      </p>

      <div class="kpi-grid">
        <form id="monitoring-entry-form" style="background:#f7f9ff; border-radius:10px; padding:10px;">
          <h3 style="margin:0 0 8px; color:var(--primary);">Monitoring Input</h3>
          <label>Project Name <input name="projectName" required style="width:100%; padding:6px;"></label>
          <label>Reporting Period <input name="reportingPeriod" required style="width:100%; padding:6px;"></label>
          <label>Province / District / Location <input name="location" style="width:100%; padding:6px;"></label>
          <label>Activity Implementation on Schedule (1‚Äì5) <input name="activityRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Budget Utilization as Planned (1‚Äì5) <input name="budgetRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Staff Availability (1‚Äì5) <input name="staffRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Community Participation (1‚Äì5) <input name="communityRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Coordination with Partners (1‚Äì5) <input name="coordinationRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Number of Beneficiaries Reached <input name="beneficiaries" type="number" min="0" style="width:100%; padding:6px;"></label>
          <label>Main Achievements this Period <textarea name="achievements" style="width:100%; padding:6px; min-height:60px;"></textarea></label>
          <label>Key Challenges / Risks <textarea name="challenges" style="width:100%; padding:6px; min-height:60px;"></textarea></label>
          <label>Immediate Actions / Recommendations <textarea name="actions" style="width:100%; padding:6px; min-height:60px;"></textarea></label>
          <button type="submit" class="login-btn" style="background:var(--primary); color:#fff;">Submit Monitoring Entry (Demo)</button>
        </form>

        <form id="evaluation-entry-form" style="background:#f7f9ff; border-radius:10px; padding:10px;">
          <h3 style="margin:0 0 8px; color:var(--primary);">Evaluation Input</h3>
          <label>Project Name <input name="evalProjectName" required style="width:100%; padding:6px;"></label>
          <label>Evaluation Phase <input name="evalPhase" style="width:100%; padding:6px;"></label>
          <label>Outcome Rating (1‚Äì5) <input name="outcomeRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Impact Rating (1‚Äì5) <input name="impactRating" type="number" min="1" max="5" style="width:100%; padding:6px;"></label>
          <label>Key Findings <textarea name="findings" style="width:100%; padding:6px; min-height:60px;"></textarea></label>
          <label>Recommendations <textarea name="evalRecommendations" style="width:100%; padding:6px; min-height:60px;"></textarea></label>
          <button type="submit" class="login-btn" style="background:var(--primary); color:#fff;">Submit Evaluation Entry (Demo)</button>
        </form>
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('dataentry')">Close</button>
    </div>

    <!-- POWER BI -->
    <div id="powerbi" class="section">
      <h2 style="margin-top:0; color:var(--primary);">Power BI Dashboard</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        When your Power BI report is ready and published, you can embed it here using an &lt;iframe&gt;.
      </p>

      <div class="table-wrapper" style="text-align:center; padding:16px; border-style:dashed;">
        Power BI embed placeholder.<br>
        Replace this box with the Power BI &lt;iframe&gt; when available.
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('powerbi')">Close</button>
    </div>

    <!-- OPENAI -->
    <div id="openai" class="section">
      <h2 style="margin-top:0; color:var(--primary);">AI Assistant (OpenAI) ‚Äì ProMEL Reasoning &amp; Reports</h2>
      <p style="margin:4px 0 10px; font-size:.85rem;">
        Sends your prompt and selected dashboard context to a backend API endpoint.
      </p>

      <div class="table-wrapper" style="padding:10px;">
        <label style="display:block; font-size:.85rem; margin-bottom:6px;"><strong>Analysis focus</strong></label>
        <select id="ai-mode" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
          <option value="explain_trends">Explain current trends & risks</option>
          <option value="draft_report">Draft narrative report (Monitoring & Evaluation)</option>
          <option value="learning_summary">Summarise key lessons & recommendations</option>
          <option value="design_questions">Design MEL questions / indicators</option>
          <option value="custom">Custom analysis</option>
        </select>

        <label style="display:block; font-size:.85rem; margin:10px 0 6px;"><strong>Prompt / question</strong></label>
        <textarea id="ai-prompt" style="width:100%; min-height:100px; padding:8px; border-radius:8px; border:1px solid #ccc;"
          placeholder="e.g. Explain the current status of the project based on the latest Monitoring & Evaluation data and highlight any critical risks."></textarea>

        <div style="margin-top:8px; font-size:.85rem;">
          <input type="checkbox" id="ai-include-filters" checked>
          <label for="ai-include-filters">Include current filters & KPI summary in analysis</label>
        </div>

        <button type="button" class="login-btn" style="background:var(--primary); color:#fff;" onclick="sendToAIAssistant()">Ask ProMEL AI (Demo)</button>
        <div id="ai-status" style="font-size:.78rem; color:#666;"></div>

        <div style="margin-top:10px;">
          <strong>AI Response</strong>
          <div id="ai-response-box" style="margin-top:6px; background:#fff; border:1px solid #dde3f3; padding:10px; border-radius:10px; white-space:pre-wrap; min-height:90px;"></div>
        </div>
      </div>

      <button class="login-btn" style="background:var(--primary); color:#fff;" onclick="closeSection('openai')">Close</button>
    </div>

  </div>

  <footer>
    &copy; 2025 ProMEL Analytics Solutions | Digital PMCEL System
  </footer>
</div>

<!-- External libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // ===========================
  // CONFIG: BACKEND AI ENDPOINT (DEMO)
  // ===========================
  const AI_API_URL = "https://httpbin.org/post";

  // Global data arrays (include header row)
  let monitoringRows = [];
  let evaluationRows = [];
  let monitoringFilteredRows = [];
  let evaluationFilteredRows = [];
  let filtersInitialized = false;

  // Charts
  let avgRatingsChart = null;
  let beneficiariesChart = null;

  // ‚úÖ Monitoring summary charts
  let monOverallByGroupChart = null;
  let monBenefByGroupChart = null;

  // ‚úÖ Evaluation summary chart (Outcome vs Impact)
  let evOutcomeImpactChart = null;

  // ===========================
  // LOGIN & INIT
  // ===========================
  document.addEventListener('DOMContentLoaded', function () {
    const loginScreen = document.getElementById('login-screen');
    const appRoot = document.getElementById('app-root');
    const loginForm = document.getElementById('login-form');

    const isLoggedIn = localStorage.getItem('promelLoggedIn') === 'true';

    if (isLoggedIn) {
      loginScreen.style.display = 'none';
      appRoot.style.display = 'block';
      initApp();
    } else {
      loginScreen.style.display = 'flex';
      appRoot.style.display = 'none';
    }

    if (loginForm) {
      loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const user = document.getElementById('login-username').value.trim();
        const pass = document.getElementById('login-password').value.trim();

        if (user === 'admin' && pass === 'ProMEL@2025') {
          localStorage.setItem('promelLoggedIn', 'true');
          loginScreen.style.display = 'none';
          appRoot.style.display = 'block';
          initApp();
        } else {
          alert('Invalid username or password.\n\nUse:\nUsername: admin\nPassword: ProMEL@2025');
        }
      });
    }
  });

  function initApp() {
    loadMonitoringTable();
    loadEvaluationTable();
    setupFilterListeners();
    setupDataEntryForms();
    setupAutoRefresh();
  }

  function setupAutoRefresh() {
    setInterval(() => {
      loadMonitoringTable();
      loadEvaluationTable();
    }, 60000);
  }

  // Show/Hide sections
  function openSection(id) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function closeSection(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  }

  // ===== CSV LOADERS =====
  function loadMonitoringTable() {
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKiND_eb3gPR0spQHucadf14xH_rX5gRtpHShan_OWJqSThbHrcx8tqCa4V_3nXjqq3duum0i6XCSE/pub?gid=1298321526&single=true&output=csv";

    fetch(csvUrl)
      .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.text(); })
      .then(text => {
        const rows = parseCSV(text);
        if (!rows || rows.length === 0) throw new Error("Monitoring CSV is empty or unparseable.");
        monitoringRows = rows;
        buildMonitoringFilters();
        applyFilters();
      })
      .catch(err => {
        console.error("Monitoring CSV error:", err);
        const tbody = document.getElementById('monitoring-body');
        if (tbody) {
          tbody.innerHTML = "<tr><td colspan='6'>Error loading monitoring data: " + err.message + "</td></tr>";
        }
      });
  }

  function loadEvaluationTable() {
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTd_zFcgy_c_5JDgK9wTVFLi5WeHTPF4uQBq9cOPl8vurc2DVu3DWrqwXiE1FmGcL5f2TtWjWLlGs1L/pub?gid=1608876672&single=true&output=csv";

    fetch(csvUrl)
      .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.text(); })
      .then(text => {
        const rows = parseCSV(text);
        if (!rows || rows.length === 0) throw new Error("Evaluation CSV is empty or unparseable.");
        evaluationRows = rows;
        applyFilters();
      })
      .catch(err => {
        console.error("Evaluation CSV error:", err);
        const tbody = document.getElementById('evaluation-body');
        if (tbody) {
          tbody.innerHTML = "<tr><td colspan='6'>Error loading evaluation data: " + err.message + "</td></tr>";
        }
      });
  }

  // Simple CSV parser
  function parseCSV(text) {
    const lines = text.trim().split("\n");
    return lines.map(line => line.split(","));
  }

  // ===== FILTERS =====
  function setupFilterListeners() {
    if (filtersInitialized) return;

    const projSel = document.getElementById('filter-project');
    const periodSel = document.getElementById('filter-period');
    const locSel = document.getElementById('filter-location');

    function onChange() { applyFilters(); }

    if (projSel) projSel.addEventListener('change', onChange);
    if (periodSel) periodSel.addEventListener('change', onChange);
    if (locSel) locSel.addEventListener('change', onChange);

    filtersInitialized = true;
  }

  function buildMonitoringFilters() {
    if (!monitoringRows.length) return;

    const headerRow = monitoringRows[0];
    const headersLower = headerRow.map(h => (h || "").trim().toLowerCase());

    const idxProject = headersLower.indexOf('project name');
    const idxPeriod = headersLower.indexOf('reporting period');
    const idxLocation = headersLower.indexOf('province / district / location');

    const projSel = document.getElementById('filter-project');
    const periodSel = document.getElementById('filter-period');
    const locSel = document.getElementById('filter-location');
    if (!projSel || !periodSel || !locSel) return;

    const currentProj = projSel.value;
    const currentPeriod = periodSel.value;
    const currentLoc = locSel.value;

    const projects = new Set();
    const periods = new Set();
    const locations = new Set();

    const dataRows = monitoringRows.slice(1).filter(r => !r.every(c => String(c || "").trim() === ""));

    dataRows.forEach(row => {
      if (idxProject !== -1 && row[idxProject]) projects.add(String(row[idxProject]).trim());
      if (idxPeriod !== -1 && row[idxPeriod]) periods.add(String(row[idxPeriod]).trim());
      if (idxLocation !== -1 && row[idxLocation]) locations.add(String(row[idxLocation]).trim());
    });

    function refillSelect(select, values, currentVal) {
      select.innerHTML = "";
      const allOpt = document.createElement('option');
      allOpt.value = "";
      allOpt.textContent = "All";
      select.appendChild(allOpt);

      Array.from(values).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });

      select.value = (currentVal && values.has(currentVal)) ? currentVal : "";
    }

    refillSelect(projSel, projects, currentProj);
    refillSelect(periodSel, periods, currentPeriod);
    refillSelect(locSel, locations, currentLoc);
  }

  function applyFilters() {
    const project = document.getElementById('filter-project')?.value || "";
    const period = document.getElementById('filter-period')?.value || "";
    const location = document.getElementById('filter-location')?.value || "";

    monitoringFilteredRows = filterMonitoringRows(monitoringRows, project, period, location);
    evaluationFilteredRows = filterEvaluationRows(evaluationRows, project, period);

    const monitorForView = monitoringFilteredRows.length ? monitoringFilteredRows : monitoringRows;
    const evalForView = evaluationFilteredRows.length ? evaluationFilteredRows : evaluationRows;

    renderMonitoringTable(monitorForView);
    renderEvaluationTable(evalForView);

    updateOverviewCard(monitorForView, evalForView);
    updateLearningCard(monitorForView);
    updateReportsCard(monitorForView);
    updateCharts(monitorForView);

    // ‚úÖ Monitoring charts (period/month)
    updateMonitoringSummaryCharts(monitorForView);

    // ‚úÖ NEW: Evaluation overall rating calculations + chart
    updateEvaluationKPIsAndChart(evalForView);
  }

  function filterMonitoringRows(allRows, project, period, location) {
    if (!allRows.length || allRows.length <= 1) return [];

    const headersLower = allRows[0].map(h => (h || "").trim().toLowerCase());
    const idxProject = headersLower.indexOf('project name');
    const idxPeriod = headersLower.indexOf('reporting period');
    const idxLocation = headersLower.indexOf('province / district / location');

    const filteredDataRows = allRows.slice(1).filter(row => {
      if (row.every(c => String(c || "").trim() === "")) return false;
      const p = idxProject !== -1 ? String(row[idxProject] || '').trim() : '';
      const per = idxPeriod !== -1 ? String(row[idxPeriod] || '').trim() : '';
      const loc = idxLocation !== -1 ? String(row[idxLocation] || '').trim() : '';

      return (project ? p === project : true)
          && (period ? per === period : true)
          && (location ? loc === location : true);
    });

    return filteredDataRows.length ? [allRows[0]].concat(filteredDataRows) : [];
  }

  function filterEvaluationRows(allRows, project, period) {
    if (!allRows.length || allRows.length <= 1) return [];

    const headersLower = allRows[0].map(h => (h || "").trim().toLowerCase());

    const idxProject = headersLower.indexOf('project name');
    const idxPeriod = headersLower.indexOf('reporting period');

    const filteredDataRows = allRows.slice(1).filter(row => {
      if (row.every(c => String(c || "").trim() === "")) return false;
      const p = idxProject !== -1 ? String(row[idxProject] || '').trim() : '';
      const per = idxPeriod !== -1 ? String(row[idxPeriod] || '').trim() : '';

      return (project ? p === project : true)
          && (period ? per === period : true);
    });

    return filteredDataRows.length ? [allRows[0]].concat(filteredDataRows) : [];
  }

  // ===== TABLE RENDERERS =====
  function renderMonitoringTable(rows) {
    const thead = document.getElementById('monitoring-head');
    const tbody = document.getElementById('monitoring-body');
    if (!thead || !tbody) return;

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!rows || !rows.length) {
      tbody.innerHTML = "<tr><td colspan='6'>No monitoring records found for current filter selection.</td></tr>";
      return;
    }

    // Header row
    const headerTr = document.createElement('tr');
    rows[0].forEach(cell => {
      const th = document.createElement('th');
      th.textContent = cell;
      headerTr.appendChild(th);
    });
    thead.appendChild(headerTr);

    const headerNames = rows[0].map(h => (h || "").trim().toLowerCase());
    const ratingHeaders = [
      "activity implementation on schedule",
      "budget utilization as planned",
      "staff availability",
      "community participation",
      "coordination with partners"
    ];
    const ratingIndices = [];
    headerNames.forEach((name, idx) => { if (ratingHeaders.includes(name)) ratingIndices.push(idx); });

    // Data rows
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (row.every(c => String(c || "").trim() === "")) continue;

      const tr = document.createElement('tr');

      row.forEach((cell, idx) => {
        const td = document.createElement('td');
        const text = String(cell || "").trim();
        td.textContent = text;

        if (ratingIndices.includes(idx) && text !== "") {
          const value = parseFloat(text);
          if (!isNaN(value)) {
            if (value >= 4) td.classList.add("status-good");
            else if (value <= 2) td.classList.add("status-bad");
            else if (value === 3) td.classList.add("status-warn");
          }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }
  }

  function renderEvaluationTable(rows) {
    const thead = document.getElementById('evaluation-head');
    const tbody = document.getElementById('evaluation-body');
    if (!thead || !tbody) return;

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!rows || !rows.length) {
      tbody.innerHTML = "<tr><td colspan='6'>No evaluation records found for current filter selection.</td></tr>";
      return;
    }

    // Header row
    const headerTr = document.createElement('tr');
    rows[0].forEach(cell => {
      const th = document.createElement('th');
      th.textContent = cell;
      headerTr.appendChild(th);
    });
    thead.appendChild(headerTr);

    // Pick first column containing "rating" for coloring (keeps your old behavior)
    const headerNames = rows[0].map(h => (h || "").trim().toLowerCase());
    let ratingIndex = -1;
    headerNames.forEach((name, idx) => {
      if (name.includes("rating") && ratingIndex === -1) ratingIndex = idx;
    });

    // Data rows
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (row.every(c => String(c || "").trim() === "")) continue;

      const tr = document.createElement('tr');

      row.forEach((cell, idx) => {
        const td = document.createElement('td');
        const text = String(cell || "").trim();
        td.textContent = text;

        if (ratingIndex === idx && text !== "") {
          const value = parseFloat(text);
          if (!isNaN(value)) {
            if (value >= 4) td.classList.add("status-good");
            else if (value <= 2) td.classList.add("status-bad");
            else if (value === 3) td.classList.add("status-warn");
          }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }
  }

  // ===== HELPERS =====
  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function averageByIndex(rows, idx) {
    if (!rows || rows.length <= 1 || idx < 0) return 0;
    let sum = 0, count = 0;
    for (let i = 1; i < rows.length; i++) {
      const v = parseFloat(rows[i][idx]);
      if (!isNaN(v)) { sum += v; count++; }
    }
    return count ? sum / count : 0;
  }

  function averageFieldFromRows(rows, headerRow, headerNameLower) {
    if (!rows.length || !headerRow.length) return 0;
    const headers = headerRow.map(h => (h || "").trim().toLowerCase());
    const idx = headers.indexOf(headerNameLower);
    return idx === -1 ? 0 : averageByIndex(rows, idx);
  }

  // ===== OVERVIEW CARD =====
  function updateOverviewCard(monitorRows, evalRows) {
    if (!monitorRows || !monitorRows.length) return;

    const headerRow = monitorRows[0];
    const headersLower = headerRow.map(h => (h || "").trim().toLowerCase());

    const idxProject = headersLower.indexOf('project name');
    const idxBenef   = headersLower.indexOf('number of beneficiaries reached this period.');
    const idxAct     = headersLower.indexOf('activity implementation on schedule');
    const idxBud     = headersLower.indexOf('budget utilization as planned');

    const projectSet = new Set();
    let totalBeneficiaries = 0;
    let monCount = 0;

    for (let i = 1; i < monitorRows.length; i++) {
      const row = monitorRows[i];
      if (row.every(c => String(c || "").trim() === "")) continue;
      monCount++;

      if (idxProject !== -1 && row[idxProject]) projectSet.add(String(row[idxProject]).trim());

      if (idxBenef !== -1 && row[idxBenef] !== undefined) {
        const b = parseFloat(row[idxBenef]);
        if (!isNaN(b)) totalBeneficiaries += b;
      }
    }

    const totalMonitoring = monCount;
    const totalEvaluation = evalRows && evalRows.length > 1 ? (evalRows.length - 1) : 0;

    const avgActivity = idxAct !== -1 ? averageByIndex(monitorRows, idxAct) : 0;
    const avgBudget   = idxBud !== -1 ? averageByIndex(monitorRows, idxBud) : 0;

    const overallScore = (avgActivity || avgBudget) ? ((avgActivity + avgBudget) / 2).toFixed(1) : "0";

    setText('ov-total-projects', projectSet.size);
    setText('ov-total-monitoring', totalMonitoring);
    setText('ov-total-evaluation', totalEvaluation);
    setText('ov-total-beneficiaries', totalBeneficiaries);
    setText('ov-overall-score', overallScore);
  }

  // ===== LEARNING CARD =====
  function updateLearningCard(monitorRows) {
    const list = document.getElementById('learning-list');
    if (!list) return;
    list.innerHTML = "";

    if (!monitorRows || !monitorRows.length) return;

    const headerRow = monitorRows[0];
    const headersLower = headerRow.map(h => (h || "").trim().toLowerCase());

    const idxProject    = headersLower.indexOf('project name');
    const idxPeriod     = headersLower.indexOf('reporting period');
    const idxAchieve    = headersLower.indexOf('main achievements this period.');
    const idxChallenges = headersLower.indexOf('key challenges / risks');
    const idxActions    = headersLower.indexOf('immediate actions required / recommendations');

    const dataRows = monitorRows.slice(1).filter(r => !r.every(c => String(c || "").trim() === ""));
    const recent = dataRows.slice(-6).reverse();

    recent.forEach(row => {
      const project = idxProject !== -1 ? (row[idxProject] || '') : '';
      const per     = idxPeriod  !== -1 ? (row[idxPeriod]  || '') : '';
      const ach     = idxAchieve !== -1 ? (row[idxAchieve] || '') : '';
      const chal    = idxChallenges !== -1 ? (row[idxChallenges] || '') : '';
      const act     = idxActions !== -1 ? (row[idxActions] || '') : '';

      const li = document.createElement('li');
      li.style.marginBottom = "10px";
      li.style.paddingBottom = "8px";
      li.style.borderBottom = "1px solid #eee";
      li.innerHTML = `<strong>${project}</strong> ‚Äì ${per}<br>‚úÖ ${ach}<br>‚ö†Ô∏è ${chal}<br>üìå ${act}`;
      list.appendChild(li);
    });
  }

  // ===== REPORTS CARD =====
  function updateReportsCard(monitorRows) {
    if (!monitorRows || !monitorRows.length) return;

    const headersLower = monitorRows[0].map(h => (h || "").trim().toLowerCase());
    const idxPeriod = headersLower.indexOf('reporting period');
    const idxDate   = headersLower.indexOf('reporting date');

    const dataRows = monitorRows.slice(1).filter(r => !r.every(c => String(c || "").trim() === ""));
    setText('rep-total', dataRows.length);

    let latestPeriod = 'N/A';
    let latestDate   = 'N/A';

    if (dataRows.length) {
      const lastRow = dataRows[dataRows.length - 1];
      if (idxPeriod !== -1) latestPeriod = lastRow[idxPeriod] || 'N/A';
      if (idxDate !== -1)   latestDate = lastRow[idxDate] || 'N/A';
    }

    setText('rep-period', latestPeriod);
    setText('rep-date', latestDate);
  }

  // ===== OVERVIEW CHARTS =====
  function updateCharts(monitorRows) {
    const ctx1 = document.getElementById('chart-avg-ratings');
    const ctx2 = document.getElementById('chart-beneficiaries');
    if (!monitorRows || monitorRows.length <= 1 || !ctx1 || !ctx2) return;

    const headerRow = monitorRows[0];
    const headersLower = headerRow.map(h => (h || "").trim().toLowerCase());

    const idxAct   = headersLower.indexOf('activity implementation on schedule');
    const idxBud   = headersLower.indexOf('budget utilization as planned');
    const idxStaff = headersLower.indexOf('staff availability');
    const idxComm  = headersLower.indexOf('community participation');
    const idxCoord = headersLower.indexOf('coordination with partners');
    const idxPeriod = headersLower.indexOf('reporting period');
    const idxBenef  = headersLower.indexOf('number of beneficiaries reached this period.');

    const avgActivity = idxAct !== -1 ? averageByIndex(monitorRows, idxAct) : 0;
    const avgBudget   = idxBud !== -1 ? averageByIndex(monitorRows, idxBud) : 0;
    const avgStaff    = idxStaff !== -1 ? averageByIndex(monitorRows, idxStaff) : 0;
    const avgComm     = idxComm !== -1 ? averageByIndex(monitorRows, idxComm) : 0;
    const avgCoord    = idxCoord !== -1 ? averageByIndex(monitorRows, idxCoord) : 0;

    const ratingLabels = ['Activity', 'Budget', 'Staff', 'Community', 'Coordination'];
    const ratingData = [avgActivity, avgBudget, avgStaff, avgComm, avgCoord];

    if (avgRatingsChart) avgRatingsChart.destroy();
    avgRatingsChart = new Chart(ctx1, {
      type: 'bar',
      data: { labels: ratingLabels, datasets: [{ label: 'Average Rating (1‚Äì5)', data: ratingData }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, suggestedMax: 5 } } }
    });

    const periodMap = new Map();
    const dataRows = monitorRows.slice(1).filter(r => !r.every(c => String(c || "").trim() === ""));
    dataRows.forEach(row => {
      if (idxPeriod === -1 || idxBenef === -1) return;
      const per = String(row[idxPeriod] || '').trim();
      const b = parseFloat(row[idxBenef] || '0');
      if (!per || isNaN(b)) return;
      periodMap.set(per, (periodMap.get(per) || 0) + b);
    });

    const periodLabels = Array.from(periodMap.keys());
    const benefData = Array.from(periodMap.values());

    if (beneficiariesChart) beneficiariesChart.destroy();
    beneficiariesChart = new Chart(ctx2, {
      type: 'line',
      data: { labels: periodLabels, datasets: [{ label: 'Total Beneficiaries', data: benefData, fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // ===========================
  // ‚úÖ Monitoring Summary Charts (period/month)
  // ===========================
  function parseMonthKey(dateStr) {
    if (!dateStr) return "";
    const s = String(dateStr).trim();
    if (!s) return "";

    const d = new Date(s);
    if (!isNaN(d.getTime())) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (mdy) {
      const mm = String(mdy[1]).padStart(2, "0");
      const yy = mdy[3];
      return `${yy}-${mm}`;
    }
    return "";
  }

  function setupMonGroupByListener() {
    const sel = document.getElementById("mon-groupby");
    if (!sel) return;
    if (sel.dataset.bound === "true") return;
    sel.dataset.bound = "true";
    sel.addEventListener("change", () => {
      const monitorForView = monitoringFilteredRows.length ? monitoringFilteredRows : monitoringRows;
      updateMonitoringSummaryCharts(monitorForView);
    });
  }

  function updateMonitoringSummaryCharts(monitorRows) {
    setupMonGroupByListener();

    const c1 = document.getElementById("mon-chart-overall-by-group");
    const c2 = document.getElementById("mon-chart-beneficiaries-by-group");
    if (!c1 || !c2) return;

    if (!monitorRows || monitorRows.length <= 1) {
      if (monOverallByGroupChart) { monOverallByGroupChart.destroy(); monOverallByGroupChart = null; }
      if (monBenefByGroupChart) { monBenefByGroupChart.destroy(); monBenefByGroupChart = null; }
      return;
    }

    const headersLower = monitorRows[0].map(h => (h || "").trim().toLowerCase());

    const idxPeriod = headersLower.indexOf("reporting period");
    const idxDate   = headersLower.indexOf("reporting date");
    const idxBenef  = headersLower.indexOf("number of beneficiaries reached this period.");

    const idxAct    = headersLower.indexOf("activity implementation on schedule");
    const idxBud    = headersLower.indexOf("budget utilization as planned");
    const idxStaff  = headersLower.indexOf("staff availability");
    const idxComm   = headersLower.indexOf("community participation");
    const idxCoord  = headersLower.indexOf("coordination with partners");

    const groupMode = document.getElementById("mon-groupby")?.value || "period"; // period|month
    const groups = new Map();

    const dataRows = monitorRows.slice(1).filter(r => !r.every(c => String(c || "").trim() === ""));
    dataRows.forEach(row => {
      const per = idxPeriod !== -1 ? String(row[idxPeriod] || "").trim() : "";
      const dt  = idxDate   !== -1 ? String(row[idxDate] || "").trim()   : "";
      const monthKey = parseMonthKey(dt);

      const key = (groupMode === "month") ? (monthKey || "Unknown Month") : (per || "Unknown Period");

      if (!groups.has(key)) groups.set(key, { ratingSum: 0, ratingCount: 0, benefTotal: 0 });
      const g = groups.get(key);

      if (idxBenef !== -1) {
        const b = parseFloat(row[idxBenef] || "0");
        if (!isNaN(b)) g.benefTotal += b;
      }

      const vals = [];
      [idxAct, idxBud, idxStaff, idxComm, idxCoord].forEach(idx => {
        if (idx !== -1) {
          const v = parseFloat(row[idx] || "");
          if (!isNaN(v)) vals.push(v);
        }
      });

      if (vals.length) {
        const rowAvg = vals.reduce((a, x) => a + x, 0) / vals.length;
        g.ratingSum += rowAvg;
        g.ratingCount += 1;
      }
    });

    const labels = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));
    const overallAvg = labels.map(k => {
      const g = groups.get(k);
      return g.ratingCount ? +(g.ratingSum / g.ratingCount).toFixed(2) : 0;
    });
    const benefTotals = labels.map(k => +(groups.get(k).benefTotal || 0).toFixed(0));

    if (monOverallByGroupChart) monOverallByGroupChart.destroy();
    monOverallByGroupChart = new Chart(c1, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: groupMode === "month" ? "Avg Overall Rating by Month (1‚Äì5)" : "Avg Overall Rating by Period (1‚Äì5)",
          data: overallAvg
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true, suggestedMax: 5 } } }
    });

    if (monBenefByGroupChart) monBenefByGroupChart.destroy();
    monBenefByGroupChart = new Chart(c2, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: groupMode === "month" ? "Total Beneficiaries by Month" : "Total Beneficiaries by Period",
          data: benefTotals,
          fill: false
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // ===========================
  // ‚úÖ NEW: Evaluation KPI Calculations + Chart
  // ===========================
  function findIndexSmart(headersLower, includesAll, includesAny = []) {
    // includesAll: all must be present; includesAny: at least one from list (optional)
    for (let i = 0; i < headersLower.length; i++) {
      const h = headersLower[i];
      const allOk = includesAll.every(x => h.includes(x));
      const anyOk = includesAny.length ? includesAny.some(x => h.includes(x)) : true;
      if (allOk && anyOk) return i;
    }
    return -1;
  }

  function formatScoreAndPercent(avgOutOf5) {
    const score = isNaN(avgOutOf5) ? 0 : avgOutOf5;
    const pct = Math.max(0, Math.min(100, (score / 5) * 100));
    return {
      scoreText: `${score.toFixed(1)} / 5`,
      pctText: `${pct.toFixed(0)}%`
    };
  }

  function updateEvaluationKPIsAndChart(evalRows) {
    // If no data, reset KPIs
    if (!evalRows || evalRows.length <= 1) {
      setText("ev-outcome-score", "0.0 / 5");
      setText("ev-outcome-percent", "0%");
      setText("ev-impact-score", "0.0 / 5");
      setText("ev-impact-percent", "0%");
      setText("ev-performance-score", "0.0 / 5");
      setText("ev-performance-percent", "0%");

      if (evOutcomeImpactChart) { evOutcomeImpactChart.destroy(); evOutcomeImpactChart = null; }
      return;
    }

    const headersLower = evalRows[0].map(h => (h || "").trim().toLowerCase());

    // Try to detect columns robustly (supports different naming styles)
    // Outcome: "outcome" + "rating"
    let idxOutcome = findIndexSmart(headersLower, ["outcome"], ["rating", "score"]);
    if (idxOutcome === -1) idxOutcome = headersLower.indexOf("outcome rating");
    // Impact: "impact" + "rating"
    let idxImpact = findIndexSmart(headersLower, ["impact"], ["rating", "score"]);
    if (idxImpact === -1) idxImpact = headersLower.indexOf("impact rating");

    const avgOutcome = idxOutcome !== -1 ? averageByIndex(evalRows, idxOutcome) : 0;
    const avgImpact  = idxImpact  !== -1 ? averageByIndex(evalRows, idxImpact)  : 0;

    // Overall performance = average of available (outcome + impact) values
    let perf = 0;
    if (avgOutcome && avgImpact) perf = (avgOutcome + avgImpact) / 2;
    else if (avgOutcome) perf = avgOutcome;
    else if (avgImpact) perf = avgImpact;

    const outFmt = formatScoreAndPercent(avgOutcome);
    const impFmt = formatScoreAndPercent(avgImpact);
    const perFmt = formatScoreAndPercent(perf);

    setText("ev-outcome-score", outFmt.scoreText);
    setText("ev-outcome-percent", outFmt.pctText);

    setText("ev-impact-score", impFmt.scoreText);
    setText("ev-impact-percent", impFmt.pctText);

    setText("ev-performance-score", perFmt.scoreText);
    setText("ev-performance-percent", perFmt.pctText);

    // Chart: Outcome vs Impact averages
    const ctx = document.getElementById("ev-chart-outcome-impact");
    if (!ctx) return;

    if (evOutcomeImpactChart) evOutcomeImpactChart.destroy();
    evOutcomeImpactChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Outcome", "Impact", "Overall Performance"],
        datasets: [{
          label: "Average Rating (1‚Äì5)",
          data: [avgOutcome, avgImpact, perf]
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, suggestedMax: 5 } }
      }
    });
  }

  // ===== PDF REPORT =====
  function generatePDFReport() {
    try {
      const jsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!jsPDF) { alert("PDF library not loaded."); return; }

      const proj = document.getElementById('ov-total-projects')?.textContent || '0';
      const mon  = document.getElementById('ov-total-monitoring')?.textContent || '0';
      const evl  = document.getElementById('ov-total-evaluation')?.textContent || '0';
      const ben  = document.getElementById('ov-total-beneficiaries')?.textContent || '0';
      const score = document.getElementById('ov-overall-score')?.textContent || '0';

      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('ProMEL PMCEL Summary Report', 10, 12);

      doc.setFontSize(10);
      doc.text('Overview (based on current filters):', 10, 22);
      doc.text('Total Projects: ' + proj, 10, 30);
      doc.text('Total Monitoring Records: ' + mon, 10, 36);
      doc.text('Total Evaluation Records: ' + evl, 10, 42);
      doc.text('Total Beneficiaries Reached: ' + ben, 10, 48);
      doc.text('Overall Performance Score (Activity & Budget): ' + score, 10, 54);

      // Also include evaluation KPIs (new)
      const outS = document.getElementById('ev-outcome-score')?.textContent || '0.0 / 5';
      const outP = document.getElementById('ev-outcome-percent')?.textContent || '0%';
      const impS = document.getElementById('ev-impact-score')?.textContent || '0.0 / 5';
      const impP = document.getElementById('ev-impact-percent')?.textContent || '0%';
      const perS = document.getElementById('ev-performance-score')?.textContent || '0.0 / 5';
      const perP = document.getElementById('ev-performance-percent')?.textContent || '0%';

      doc.text('Evaluation Ratings (from current filters):', 10, 64);
      doc.text('Outcome: ' + outS + ' (' + outP + ')', 10, 70);
      doc.text('Impact: ' + impS + ' (' + impP + ')', 10, 76);
      doc.text('Overall Performance: ' + perS + ' (' + perP + ')', 10, 82);

      doc.text('Generated by ProMEL Analytics Solutions', 10, 98);
      doc.save('ProMEL_PMEL_Report.pdf');
    } catch (e) {
      console.error(e);
      alert('Unable to generate PDF report. See console for details.');
    }
  }

  // ===== DATA ENTRY FORMS (DEMO) =====
  function setupDataEntryForms() {
    const monForm = document.getElementById('monitoring-entry-form');
    const evalForm = document.getElementById('evaluation-entry-form');

    if (monForm) {
      monForm.addEventListener('submit', function (e) {
        e.preventDefault();
        alert('Monitoring entry captured in the browser.\n\nTo send this to Google Sheets, connect this form to a Google Apps Script Web App endpoint.');
      });
    }

    if (evalForm) {
      evalForm.addEventListener('submit', function (e) {
        e.preventDefault();
        alert('Evaluation entry captured in the browser.\n\nTo send this to Google Sheets, connect this form to a Google Apps Script Web App endpoint.');
      });
    }
  }

  // ===== AI ASSISTANT (DEMO HOOK) =====
  async function sendToAIAssistant() {
    const mode = document.getElementById('ai-mode')?.value || 'custom';
    const prompt = (document.getElementById('ai-prompt')?.value || '').trim();
    const includeFilters = document.getElementById('ai-include-filters')?.checked ?? true;

    const statusEl = document.getElementById('ai-status');
    const responseBox = document.getElementById('ai-response-box');

    if (!prompt) { alert('Please enter a prompt or question for the AI assistant.'); return; }

    const project = document.getElementById('filter-project')?.value || '';
    const period = document.getElementById('filter-period')?.value || '';
    const location = document.getElementById('filter-location')?.value || '';

    const kpis = {
      totalProjects: document.getElementById('ov-total-projects')?.textContent || '0',
      totalMonitoring: document.getElementById('ov-total-monitoring')?.textContent || '0',
      totalEvaluation: document.getElementById('ov-total-evaluation')?.textContent || '0',
      totalBeneficiaries: document.getElementById('ov-total-beneficiaries')?.textContent || '0',
      overallScore: document.getElementById('ov-overall-score')?.textContent || '0',
      evalOutcome: (document.getElementById('ev-outcome-score')?.textContent || '0.0 / 5') + " (" + (document.getElementById('ev-outcome-percent')?.textContent || '0%') + ")",
      evalImpact: (document.getElementById('ev-impact-score')?.textContent || '0.0 / 5') + " (" + (document.getElementById('ev-impact-percent')?.textContent || '0%') + ")",
      evalPerformance: (document.getElementById('ev-performance-score')?.textContent || '0.0 / 5') + " (" + (document.getElementById('ev-performance-percent')?.textContent || '0%') + ")"
    };

    const payload = {
      mode,
      user_prompt: prompt,
      include_filters: includeFilters,
      filters: { project, period, location },
      kpi_snapshot: kpis
    };

    statusEl.textContent = 'Sending request to demo AI endpoint (httpbin.org)...';
    responseBox.textContent = '';

    try {
      const res = await fetch(AI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' from AI backend');

      const data = await res.json();
      const echoed = data.json || data;

      responseBox.textContent =
        'Demo response from httpbin.org (this is just echoing what you sent):\n\n' +
        JSON.stringify(echoed, null, 2);

      statusEl.textContent = 'Demo AI response received.';
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error contacting AI backend: ' + err.message;
      responseBox.textContent = '';
    }
  }
</script>

</body>
</html>

<body>
